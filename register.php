<?php/** * @author Kevin Bohinski <bohinsk1@tcnj.edu> * @version 1.0 * @since 2015-12-1 * * Project Name:  HackTCNJ 2016 * Description:   HackTCNJ 2016 registration site. * * Filename:      /register.php * Description:   Registration script for HackTCNJ 2016 site. * Last Modified: 2016-1-3 * * Copyright (c) 2015 Kevin Bohinski. All rights reserved. */require_once('WebContent/db.php');require_once('mc.php');session_start();/* If already logged in, take them to their dashboard */if (isset($_SESSION['id'])) {    header("Location: dashboard.php");    exit();}/* If user hasnt completed the oauth process with MLH, send them back */if (!isset($_SESSION['mlh_user'])) {    header("Location: register_mlh.php");    exit();}/* Create an empty error array so we can inform the user on what the issue with their submission is */$err = array();/* If form is submitted */if (isset($_POST['submit'])) {    $errText = "Required field";    /* Check if user exists in db */    $email = mysql_entities_fix_string($db, $_SESSION['mlh_user']['data']['email']);    $first = mysql_entities_fix_string($db, $_SESSION['mlh_user']['data']['first_name']);    $last = mysql_entities_fix_string($db, $_SESSION['mlh_user']['data']['last_name']);    $mlh_id = mysql_entities_fix_string($db, $_SESSION['mlh_user']['data']['id']);    $sql = "select id from hackers where mlh_id = '{$mlh_id}'";    $result = mysqli_query($db, $sql) or die('Query failed: ' . mysqli_error($db));    if (mysqli_num_rows($result) > 0) {        $err['general'] = "You already have an account";    }    if (!empty($_FILES["resume"])) {        $f = $_FILES["resume"];        if ($f["error"] !== UPLOAD_ERR_OK) {            $err['resume'] = "An error occured";        }        $ext = pathinfo($_FILES['resume']['name'], PATHINFO_EXTENSION);        if ($ext != "pdf" && $ext != "doc" && $ext != "docx" && $ext != "txt") {            $err['resume'] = "Only pdf, doc, docx, or txt please";        }        $name = $first . "_" . $last . "_" . $email . "_" . "Resume" . "." . $ext;        $success = move_uploaded_file($f["tmp_name"], UPLOAD_DIR . $name);        if (!$success) {            $err['resume'] = "An error occured";        }    } else {        $err['resume'] = $errText;    }    /* If there are no errors, add user to db */    if (sizeof($err) == 0) {        /* Clean input to avoid sql injection */        $website = mysql_entities_fix_string($db, $_POST['website']);        $linkedin = mysql_entities_fix_string($db, $_POST['linkedin']);        $github = mysql_entities_fix_string($db, $_POST['github']);        $minor = false;        $age = strtotime($_SESSION['mlh_user']['data']['date_of_birth']);        if ($age > strtotime($HACKATHON_MINOR_DATE)) {            $minor = true;        }        /* Check if we hit waitlist cap */        $waitlist = false;        $sql = "select id from hackers";        $result = mysqli_query($db, $sql) or die('Query failed: ' . mysqli_error($db));        if (mysqli_num_rows($result) > $REGRISTRATION_CAP_WAITLIST_START && !isset($_SESSION['tcnj'])) {            $waitlist = true;        }        /* Add the user to the db */        $sql = "INSERT INTO `hackers`";        $sql .= "(`id`, `mlh_id`, `checked_in`, `website`, `linkedin`, `github`, `minor`, `waitlisted`, `admin`) VALUES ";        $sql .= "(null,'{$mlh_id}',false,'{$website}','{$linkedin}','{$github}','{$minor}`','{$waitlist}',false)";        $result = mysqli_query($db, $sql) or die('Query failed: ' . mysqli_error($db));        /* Get id from db */        $sql = "SELECT id FROM `hackers` WHERE mlh_id='{$mlh_id}'";        $result = mysqli_query($db, $sql) or die('Query failed: ' . mysqli_error($db));        $row = mysqli_fetch_assoc($result);        $db_id = $row['id'];        /* Send a welcome email */        error_reporting(E_ALL & ~E_NOTICE);        $msg = "Dear " . $first . " " . $last . ",\n\n";        $msg .= "Thanks for applying!\n";        if ($waitlist) {            $msg .= "Sorry! We have hit our registration capacity. You have been placed on the waitlist.\n";            $msg .= "We will let you know if space opens up.\n";        } else {            $msg .= "You are fully registered! We will send you more info closer to the hackathon.\n";        }        $msg .= "Please accept the subscription request email we sent you with MailChimp.\n";        $msg .= "\nPlease share with your friends and follow us on twitter for updates.\n";        $msg .= "\nThanks Again!\nThe HackTCNJ Team\nhttp://www.twitter.com/hacktcnj";        mail($email, "HackTCNJ - Thanks for applying", $msg, "From: noreply@hacktcnj.com");        /* INTEGRATE WITH MAILCHIMP API TO ADD EMAIL TO MAILCHIMP. */        $mc = new mc();        $mc->addEmail($email, $first, $last, $db_id, $waitlist);        /* Set session vars */        $_SESSION['id'] = $db_id;        $_SESSION['mlh_id'] = $mlh_id;        $_SESSION['first_name'] = $first;        /* Redirect them to the dashboard page. */        header("Location: " . $dir . "/dashboard.php");        exit();    }}$CURRENT_PAGE = "register";require_once('header.php');?>    <h1>Register</h1><?phpif (sizeof($err) > 0) {    echo '<div style="margin-top: 20px; margin-bottom: 40px;" class="alert alert-danger"><strong>Oops!</strong></br>There was an error with your submission. Please check that all required fields are filled.</div>';}if (isset($err['general'])) {    echo '<div style="margin-top: 20px; margin-bottom: 40px;" class="alert alert-danger"><strong>' . $err['general'] . '</strong></div>';}if (isset($_SESSION['tcnj'])) {    echo '<div style="margin-top: 20px; margin-bottom: 40px;" class="alert alert-success"><strong>Thanks!</strong></br>Thanks for logging in with TCNJ. It helps us with waitlisting.</div>';}?>    <form method="post" id="register-form" action="register.php" enctype="multipart/form-data">                <div class="form-group">                    <label for="website">Website</label>                    <input id="website" name="website" type="url" value="<?php if (isset($_POST['website'])) {                        echo $_POST['website'];                    } ?>" placeholder="http://www.website.com/..."                           class="form-control"/>                </div>                <div class="form-group">                    <label for="linkedin">LinkedIn</label>                    <input id="linkedin" name="linkedin" type="url" value="<?php if (isset($_POST['linkedin'])) {                        echo $_POST['linkedin'];                    } ?>" placeholder="http://www.linkedin.com/..."                           class="form-control"/>                </div>                <div class="form-group">                    <label for="github">GitHub</label>                    <input id="github" name="github" type="url" value="<?php if (isset($_POST['github'])) {                        echo $_POST['github'];                    } ?>" placeholder="http://www.github.com/..."                           class="form-control"/>                </div>                <div class="form-group">                    <label for="resume">Resume<span class="text-danger">*</span></label>                    <input id="resume" name="resume" type="file" class="form-control"/>                    <span class="text-danger"><?php if (isset($err['resume'])) {                            echo $err['resume'];                        } ?></span>                </div>        <div class="form-group">            <input style="margin-top: 8px;" name="submit" type="submit" value="Submit" class="btn btn-primary"/>        </div>    </form>    <div style="margin-top: 45px;">        <img class="img-responsive" style="max-height: 60px; margin:auto;" src="./WebContent/s3.png" alt="Step 3 of 3"/>        <p style="font-size: 20px;"><b>Step 3 of 3 to register.</b></p>    </div><?php require_once('footer.php'); ?>